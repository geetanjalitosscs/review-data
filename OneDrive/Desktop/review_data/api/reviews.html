<script>
// This file acts as an API endpoint that returns JSON
// Access via: /api/reviews.html or /api/reviews.html?rating=5&sort=date

(async function() {
    try {
        // Get the base URL and construct path to reviews.json
        const baseUrl = window.location.origin;
        const currentPath = window.location.pathname;
        // Remove /api/reviews.html to get base path
        const basePath = currentPath.replace(/\/api\/.*$/, '');
        const reviewsPath = basePath + (basePath.endsWith('/') ? '' : '/') + 'reviews.json';
        
        // Load reviews data
        const response = await fetch(reviewsPath);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch reviews.json from ${reviewsPath}: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data) {
            throw new Error('No data returned from reviews.json');
        }
        
        if (!data.reviews) {
            throw new Error('Invalid data format: reviews array not found. Data structure: ' + JSON.stringify(Object.keys(data)));
        }
        
        if (!Array.isArray(data.reviews)) {
            throw new Error('Reviews is not an array. Type: ' + typeof data.reviews);
        }
        
        let reviews = data.reviews;
        
        // Parse query parameters
        const urlParams = new URLSearchParams(window.location.search);
        const rating = urlParams.get('rating');
        const product = urlParams.get('product');
        const name = urlParams.get('name');
        const dateFrom = urlParams.get('dateFrom');
        const dateTo = urlParams.get('dateTo');
        const sort = urlParams.get('sort');
        const order = urlParams.get('order') || 'asc';
        const page = parseInt(urlParams.get('page')) || 1;
        const limit = parseInt(urlParams.get('limit')) || (reviews ? reviews.length : 0);
        
        // Apply filters
        if (rating) {
            reviews = reviews.filter(r => r.rating === parseInt(rating));
        }
        if (product) {
            reviews = reviews.filter(r => 
                r.product.toLowerCase().includes(product.toLowerCase())
            );
        }
        if (name) {
            reviews = reviews.filter(r => 
                r.name.toLowerCase().includes(name.toLowerCase())
            );
        }
        if (dateFrom) {
            reviews = reviews.filter(r => r.date >= dateFrom);
        }
        if (dateTo) {
            reviews = reviews.filter(r => r.date <= dateTo);
        }
        
        // Sort
        if (sort) {
            const orderMultiplier = order === 'desc' ? -1 : 1;
            reviews.sort((a, b) => {
                if (a[sort] < b[sort]) return -1 * orderMultiplier;
                if (a[sort] > b[sort]) return 1 * orderMultiplier;
                return 0;
            });
        }
        
        // Pagination
        const start = (page - 1) * limit;
        const end = start + limit;
        const paginatedReviews = reviews.slice(start, end);
        
        // Return JSON response
        const result = {
            success: true,
            status: 200,
            data: paginatedReviews,
            pagination: {
                page: page,
                limit: limit,
                total: reviews.length,
                totalPages: Math.ceil(reviews.length / limit)
            },
            filters: {
                rating: rating || null,
                product: product || null,
                name: name || null,
                dateFrom: dateFrom || null,
                dateTo: dateTo || null,
                sort: sort || null,
                order: order
            }
        };
        
        // Output JSON (this will be the only content)
        document.write('<pre>' + JSON.stringify(result, null, 2) + '</pre>');
        
    } catch (error) {
        const errorResponse = {
            error: true,
            status: 500,
            message: error.message
        };
        document.write('<pre>' + JSON.stringify(errorResponse, null, 2) + '</pre>');
    }
})();
</script>

