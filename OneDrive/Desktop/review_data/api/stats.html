<script>
// This file acts as an API endpoint that returns statistics
// Access via: /api/stats.html

(async function() {
    try {
        // Get the base URL and construct path to reviews.json
        const currentPath = window.location.pathname;
        const basePath = currentPath.replace(/\/api\/.*$/, '');
        const reviewsPath = basePath + (basePath.endsWith('/') ? '' : '/') + 'reviews.json';
        
        const response = await fetch(reviewsPath);
        
        if (!response.ok) {
            throw new Error(`Failed to fetch reviews.json from ${reviewsPath}: ${response.status} ${response.statusText}`);
        }
        
        const data = await response.json();
        
        if (!data || !data.reviews || !Array.isArray(data.reviews)) {
            throw new Error('Invalid data format: reviews array not found');
        }
        
        const reviews = data.reviews;
        
        const total = reviews.length;
        const avgRating = reviews.reduce((sum, r) => sum + r.rating, 0) / total;
        
        const ratingDistribution = {};
        reviews.forEach(r => {
            ratingDistribution[r.rating] = (ratingDistribution[r.rating] || 0) + 1;
        });
        
        const productCount = {};
        reviews.forEach(r => {
            productCount[r.product] = (productCount[r.product] || 0) + 1;
        });
        
        const result = {
            success: true,
            status: 200,
            data: {
                totalReviews: total,
                averageRating: parseFloat(avgRating.toFixed(2)),
                ratingDistribution: ratingDistribution,
                productCount: productCount,
                fiveStarReviews: ratingDistribution[5] || 0,
                oneStarReviews: ratingDistribution[1] || 0
            }
        };
        
        document.write('<pre>' + JSON.stringify(result, null, 2) + '</pre>');
        
    } catch (error) {
        const errorResponse = {
            error: true,
            status: 500,
            message: error.message
        };
        document.write('<pre>' + JSON.stringify(errorResponse, null, 2) + '</pre>');
    }
})();
</script>

